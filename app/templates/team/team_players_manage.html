{% extends 'base.html' %}
{% load static %}

{% block head %}
<title>ATUM ADMIN</title>
<link rel="stylesheet" href="{% static 'css/modal.css' %}">
{% endblock head %}

{% block navbar %}


<style>
    .title-adm{
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 7em;
        width: 100%;
        color: var(--global-header-color);
    }
    @media screen and (max-width: 700px) {
        .title-adm{
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding-top: 15px;
            height: auto;
            padding-bottom: 15px;
            gap: 15px;
        }
        .block1{
            padding-inline: 4vw;
        }
    }

    .title-buttons{
        width: 20em;
        height: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .title-buttons > span{
        width: 7em;
        height: 2.8em;
        padding: 0;
        border-radius: 8px;
        background-color: var(--global-header-color);
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        cursor: pointer;
        margin-right: 5px;
    }
    .title-buttons p, a{
        color: white;
        font-size: 20px;
        font-weight: 500;
    }

    .title-buttons > select{
        width: 12em;
        height: 2.8em;
        font-size: 16px;
        cursor: pointer;
    }
    .input-search-adm{
        width: 100%;
    }
    .input-search-adm input{
        width: 100%;
    }
</style>


{% endblock navbar %}

{% block content %}

<div class="all-block">
    <div class="block1">
        <div class="title-adm">
            <h1>
                ATLETAS DO {{team_sport.team.name|upper}} {{team_sport.sport.get_sport_display|upper}} {{team_sport.get_sexo_display|upper}} 
            </h1>
            <div class="title-buttons">
                <span onclick="openChooseModal()"><p>Novo</p></span>
                <span style="background-color: var(--global-seventh-color);"> <a {% if user.type == 0 %} href="{% url 'team_manage' %}?e={{team_sport.team.event.id}}&t={{team_sport.team.id}}" {% else %} href="{% url 'team_manage' %}?t={{team_sport.team.id}}" {% endif %}>Voltar</a></span>
            </div>
        </div>
        <form method="post" onsubmit="adicionarCamposOcultos(this)" class="input-search-adm">
            {% csrf_token %}
            <input name="search" type="search" id="search-input" onkeyup="search_table()" placeholder="Procure pelo nome">
        </form>
        <section class="all-table" style="width: 100%; max-width: none; margin-top: 15px;">
            <table id="search-table" style="width: 100%;">
                <tr class="hidden">
                    <th>ID</th>
                    <th>NOME</th>
                    <th>MATRÍCULA</th>
                    <th>SEXO</th>
                    <th>DATA NASC.</th>
                    <th>FOTO</th>
                    <th>BOLETIM</th>
                    <th>RG</th>
                    {% if allowed and perms.app.change_player_team_sport and perms.app.change_player %}
                    <th>EDITAR</th>
                    {% endif %}
                    {% if allowed and perms.app.delete_player_team_sport and perms.app.delete_player %}
                    <th>REMOVER</th>
                    {% endif %}
                </tr>
                {% for i in player_team_sport %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                        {{ i.player.name }}
                    </td>
                    <td>{{i.player.registration}}</td>
                    <td>{{i.player.get_sexo_display}}</td>
                    <td>{{i.player.date_nasc}}</td>
                    <td>{% if i.player.photo %} <img src="{% static 'images/icon-true.svg' %}"> {% else %} <img src="{% static 'images/icon-false.svg' %}"> {% endif %}</td>
                    <td>
                        {% if i.player.bulletin %}                      
                        <a href="{{ i.player.bulletin.url }}" download="{{ i.player.bulletin.name }}">
                            <img style="width: 1.5em;" src="{% static 'images/download-solid.svg' %}" alt="Download">
                        </a>
                        {% else %}
                            <img src="{% static 'images/icon-false.svg' %}">
                        {% endif %}
                    </td>
                    <td> 
                        {% if i.player.rg %}                      
                        <a href="{{ i.player.rg.url }}" download="{{ i.player.rg.name }}">
                            <img style="width: 1.5em;" src="{% static 'images/download-solid.svg' %}" alt="Download">
                        </a>
                        {% else %}
                            <img src="{% static 'images/icon-false.svg' %}">
                        {% endif %}                      
                    </td>
                    {% if allowed and perms.app.change_player_team_sport and perms.app.change_player %}
                    <td>
                        <img style="cursor: pointer;" src="{% static 'images/icon-edit.svg' %}" onclick="openEditModal('{{ i.player.id }}','{{ i.player.name }}','{{ i.player.registration }}','{{ i.player.sexo }}','{{ i.player.date_nasc|date:'Y-m-d' }}','{{ i.player.photo.url }}','{{ i.player.bulletin.url }}','{{ i.player.rg.url }}')">
                    </td>
                    {% endif %}
                    {% if allowed and perms.app.delete_player_team_sport and perms.app.delete_player %}
                    <td>
                        <form method="POST" action=""z>
                            {% csrf_token %}
                            <button data-confirm="Você realmente deseja excluir este jogador?" name="player_delete" value="{{i.player.id}}" style="background-color: transparent; border: none;">
                                <img src="{% static 'images/icon-trash.svg' %}" style="color: blue;" alt="">
                            </button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% empty %}
                <style>
                    .hidden {
                        display: none;
                    }
                </style>
                <section class="alert-page">
                    <div class="alert-img"> <i class="fa-solid fa-circle-exclamation"></i> </div>
                    <div class="alert-text">
                        <p>NÃO HÁ NENHUM ATLETA CADASTRADO NESSE TIME.</p>
                    </div>
                </section>
                {% endfor %}
            </table>
        </section>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Editar atleta</h2>
        <form method="post" enctype="multipart/form-data" id="editForm">
            {% csrf_token %}
            <input type="hidden" id="editPlayerId" name="edit-player-id">

            <label>Nome Completo</label>
            <input id="editPlayerName" type="text" name="edit-name" required>

            <label>Matrícula, siape ou CPF</label>
            <input id="editPlayerRegistration" type="text" name="edit-registration" required>
            <p style="color: #6d6c6c; font-size: 14px;">
                *Matrícula para aluno, SIAPE para servidores e CPF para estagiário ou servidor sem SIAPE.
            </p>

            <label>Data nasc.</label>
            <input id="editPlayerDate" type="date" name="edit-date" required>

            <label>Sexo</label>
            <select name="edit-sexo" id="editPlayerSexo" required>
                <option disabled>Selecione a função</option>
                {% for value, name in sexos %}
                <option value="{{ value }}" id="type_{{ value }}">{{ name }}</option>
                {% endfor %}
            </select>

            <label for="photo">Foto de Perfil</label>
            <input type="file" name="edit-photo" id="edit-photo" accept=".jpg, .jpeg, .png" onchange="previewFoto()" />
            <p style="color: #6d6c6c; font-size: 15px;">
                *Anexe uma nova Fotografia apenas se quiser troca-la.
            </p>

            <p id="preview-name" style="margin-top: 10px; color: #444;">Fotografia atual:</p>
            <img id="preview" src="{{ voluntary.photo.url }}" alt="Foto atual"
                style="max-width: 150px; display: block; margin-top: 5px;" />

            <label for="photo">Boletim</label>
            <input type="file" name="edit-bulletin" id="editPlayerBulletin" accept=".jpg, .jpeg, .png" />
            <p style="color: #6d6c6c; font-size: 15px;">
                *Anexe um novo boletim apenas se quiser trocar.
            </p>

            <label for="photo">RG</label>
            <input type="file" name="edit-rg" id="editPlayerRG" accept=".jpg, .jpeg, .png" />
            <p style="color: #6d6c6c; font-size: 15px;">
                *Anexe um novo rg apenas se quiser trocar.
            </p>

            <button class="button-modal" type="submit">Salvar Alterações</button>
        </form>
    </div>
</div>

<div id="newModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Adicionar atleta</h2>
        <form method="post" enctype="multipart/form-data" id="editForm">
            {% csrf_token %}
            <label for="nome">Nome completo do atleta</label>
            <input type="text" autocomplete="on" autocorrect="on" id="name" name="name" placeholder="Nome*"
                required>
            <label for="date" >Data de nascimento</label>
            <input type="date" autocomplete="on" autocorrect="on" name="date" id="date"
                    placeholder="Data de nascimento*" required>
            <label for="registration">Matrícula</label>
            <input type="text" autocomplete="on" autocorrect="on" id="registration" name="registration"
                placeholder="Matrícula*" required>
            <label for="registration">CPF</label>
            <input type="text" id="cpf" name="cpf"
                placeholder="CPF*" required maxlength="14">
            {% if team_sport.sport.sport == 2 %}
            <label for="sexos">Sexo</label>
            <select id="sexos" name="sexo">
                <option selected disabled value="None">Selecione o sexo</option>
                <option value="0">Masculino</option>
                <option value="1">Feminino</option>
            </select>
            {% endif %}
            <label for="Boletin">Boletim (PDF)</label>
            <input type="file" name="bulletin" id="bulletin" accept=".pdf" required>
            <label for="Fotografia">Fotografia (JPG, JPEG ou PNG)</label>
            <input type="file" name="photo" id="fotos" accept=".jpg, .jpeg, .png" required>
            <label for="Rg">RG (PDF, JPG, JPEG ou PNG)</label>
            <input type="file" name="rg" id="general-register" required>

            <button class="button-modal" type="submit">Salvar Alterações</button>
        </form>
    </div>
</div>

<div id="chooseModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeChooseModal()">&times;</span>
        <h2>Adicionar atleta</h2>
        <p>Você irá escolher uma opção</p>
        <br>
        <p>Para cadastrar um novo atleta, que não está inscrito em <b>nenhum</b> time. Aperte no botão azul.</p>
        <br>
        <p>Para adicionar ao time um atleta que já foi cadastrado no sistema em outro time aperte no botão verde.</p>
        <br>
        <div class="buttons-options">
            <span onclick="openModal()" class="button-op-1" style="background-color: blue;">
                <i class="fa-solid fa-arrow-up-right-from-square"></i>
            </span>
            <span onclick="openSearchModal()" class="button-op-2" style="background-color: green;">
                <i class="fa-solid fa-arrow-up-right-from-square"></i>
            </span>
        </div>
    </div>
</div>

<div id="searchModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeSearchModal()">&times;</span>
        <h2>Adicionar atleta</h2>
        <p>Procure pelo nome.</p>
        <form method="post" enctype="multipart/form-data" id="searchForm">
            {% csrf_token %}
            <input name="search" type="search" placeholder="Procure pelo nome">

            <button class="button-modal" type="submit">Adicionar</button>
        </form>
    </div>
</div>

<script>
    function openModal() {
        document.getElementById("chooseModal").style.display = "none";
        document.getElementById("newModal").style.display = "block";
    }

    function closeModal() {
        document.getElementById("newModal").style.display = "none";
    }

    function openSearchModal() {
        document.getElementById("chooseModal").style.display = "none";
        document.getElementById("searchModal").style.display = "block";
    }

    function closeSearchModal() {
        document.getElementById("searchModal").style.display = "none";
    }

    function openChooseModal() {
        document.getElementById("chooseModal").style.display = "block";
    }

    function closeChooseModal() {
        document.getElementById("chooseModal").style.display = "none";
    }

    // Variável global para restaurar a foto original ao fechar o modal
    let originalPhotoUrl = '';

    function openEditModal(id, name, registration, sexo, data_nasc, photoUrl, bulletinUrl, rgUrl) {
        originalPhotoUrl = photoUrl || '';

        // Resetar campos de imagem
        const photoInput = document.getElementById('edit-photo');
        photoInput.value = '';

        // Preencher campos de texto
        document.getElementById("editPlayerId").value = id;
        document.getElementById("editPlayerName").value = name;
        document.getElementById("editPlayerRegistration").value = registration;

        // 📅 Corrigir o valor do input type="date"
        const dateInput = document.getElementById("editPlayerDate");
        if (data_nasc && data_nasc.includes('/')) {
            // Se a data vier como "DD/MM/AAAA"
            const [dia, mes, ano] = data_nasc.split('/');
            dateInput.value = `${ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
        } else {
            // Se já estiver em "YYYY-MM-DD"
            dateInput.value = data_nasc;
        }

        // Selecionar o sexo
        const sexoSelect = document.getElementById("editPlayerSexo");
        if (sexoSelect) {
            Array.from(sexoSelect.options).forEach(option => {
                option.selected = option.value === sexo;
            });
        }

        // 📷 Mostrar a foto atual, se existir
        const preview = document.getElementById('preview');
        const previewName = document.getElementById('preview-name');
        if (originalPhotoUrl) {
            preview.src = originalPhotoUrl;
            preview.style.display = 'block';
            previewName.textContent = "Fotografia atual:";
        } else {
            preview.src = '';
            preview.style.display = 'none';
            previewName.textContent = "Nenhuma fotografia cadastrada";
        }

        // Exibir o modal
        document.getElementById("editModal").style.display = "block";
    }

    function previewFoto() {
        const input = document.getElementById('edit-photo');
        const preview = document.getElementById('preview');
        const previewName = document.getElementById('preview-name');

        if (input.files && input.files[0]) {
            // Mostrar nova imagem selecionada
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
                previewName.textContent = "Nova fotografia:";
            };
            reader.readAsDataURL(input.files[0]);
        } else {
            if (originalPhotoUrl) {
                preview.src = originalPhotoUrl;
                preview.style.display = 'block';
                previewName.textContent = "Fotografia atual:";
            } else {
                preview.style.display = 'none';
                previewName.textContent = "Nenhuma fotografia cadastrada";
            }
        }
    }

    function closeEditModal() {
        const modal = document.getElementById("editModal");
        modal.style.display = "none";

        // Resetar tudo
        const form = document.getElementById("editForm");
        form.reset();
        
        const preview = document.getElementById('preview');
        const previewName = document.getElementById('preview-name');
        const photoInput = document.getElementById('photo');
        
        photoInput.value = '';
        preview.style.display = 'none';
        previewName.textContent = "Nenhuma fotografia selecionada";
        originalPhotoUrl = '';

        // Resetar selects
        ['editTypeVoluntary', 'editUserSelect', 'editEventSelect'].forEach(id => {
            const select = document.getElementById(id);
            if (select) select.selectedIndex = 0;
        });
    }
</script>

{% endblock content %}

            <div style="display: flex; width: auto; height: auto; justify-content: center; align-items: center; gap: 15px;">
                {% if allowed and perms.app.add_player_team_sport and perms.app.add_player %}
                <button class="side-bar-buttons-items2 custom-buttons-sport-nav" style="background-color: var(--global-color-green);">
                    <a href="{% url 'guiate_players_team' team_sport.team.name team_sport.get_sexo_display team_sport.sport.get_sport_display team_sport.team.event.id %}" style="color: #ffffff; font-size: 25px;">ADICIONAR MAIS</a>
                </button> 
                {% endif %}      
                <button class="side-bar-buttons-items2  custom-buttons-sport-nav cursor-block" style="background-color: var(--global-seventh-color);">
                    <a href="{% url 'team_manage' %}" style="color: #ffffff; font-size: 25px;">VOLTAR</a>
                </button>
            </div>