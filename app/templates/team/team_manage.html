{% extends 'base.html' %}
{% load static %}

{% block head %}
<title>ATUM ADMIN</title>
{% endblock head %}

{% block navbar %}

<link rel="stylesheet" href="{% static 'css/modal.css' %}">

<style>
    .btn-add {
        display: block;
        margin: 10px 0;
        padding: 10px 20px;
        background-color: var(--global-tenth-color);
        color: white;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .btn-add:hover {
        background-color: #0e1e49;
    }
    
    .menu_team {
        width: 100%;
        height: auto;
        margin-top: 25px;
        padding: 20px;
        background-color: #dfdfdf;
        border-radius: 15px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 22px;
    }

    .button_team {
        width: 7.5em;
        height: 12em;
        border-radius: 15px;
    }    
    .button_team button{
        border: 0;
        background-color: transparent;
    }
    .item {
        height: 4px;
        background-color: #004FC7;
        border-radius: 25px;
        margin-top: 12px;
        width: 0;
        margin-left: auto;
        margin-right: auto;
        animation: growBar 1.2s ease-out forwards;
    }

    @keyframes growBar {
        0% {
            width: 0;
        }
        100% {
            width: 70%; 
        }
    }



    .button_team img {
        width: 7.5em;
        height: 7.5em;
        object-fit: cover;
        border-radius: 15px;
    }
    .button_team p{
        text-align: center;
        font-size: 20px;
        color: #004FC7;
        font-weight: 600;
    }

    /* Oculta a scrollbar se quiser (opcional) */
    .menu_team::-webkit-scrollbar {
        display: none;
    }
    .subtitle-adm{
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 5.5em;
        width: 100%;
        color: var(--global-header-color);
    }
    .title-adm{
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 7em;
        width: 100%;
        color: var(--global-header-color);
    }
    @media screen and (max-width: 700px) {
        .title-adm{
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding-top: 15px;
            height: auto;
            padding-bottom: 15px;
            gap: 15px;
        }
        .subtitle-adm{
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding-top: 15px;
            height: auto;
            padding-bottom: 15px;
            gap: 15px;
        }
        .block1{
            padding-inline: 4vw;
        }
        .subtitle-buttons{
            justify-content: space-around;
        }
        .menu_team{
            justify-content: space-around;
        }
    }
    @media screen and (min-width: 700px) {
        .subtitle-buttons{
            justify-content: end;
        }
    }

    .title-buttons{
        width: 20em;
        height: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .title-buttons > span{
        width: 7em;
        height: 2.8em;
        padding: 0;
        border-radius: 8px;
        background-color: var(--global-header-color);
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        margin-right: 5px;
    }
    .title-buttons p{
        color: white;
        font-size: 20px;
        font-weight: 500;
    }
    .title-buttons > select{
        width: 12em;
        height: 2.8em;
        font-size: 16px;
        cursor: pointer;
    }
    .subtitle-buttons{
        width: 22em;
        height: auto;
        display: flex;
        align-items: center;
    }
    .subtitle-button-span{
        width: auto;
        height: 3em;
        padding-left: 7px;
        padding-right: 7px;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        margin-right: 10px;
    }
    h2{
        font-size: 1.8em;
    }
    .subtitle-button-gear{
        width: 3em;
        height: 3em;
        padding: 0;
        border-radius: 8px;
        background-color: #2F2F2F;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        margin-right: 5px;
    }
    .subtitle-button-file{
        width: 3em;
        height: 3em;
        padding: 0;
        border-radius: 8px;
        background-color: #2F2F2F;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        margin-right: 10px;
        
    }
    .subtitle-buttons i{
        font-size: 24px;
        color: white;
    }

    .subtitle-buttons p{
        color: white;
        font-size: 20px;
        font-weight: 500;
    }
    .input-search-adm{
        width: 100%;
    }
    .input-search-adm input{
        width: 100%;
    }
    .description-team{
        font-size: 20px;
        font-weight: 400;
        color: #004FC7;
    }

    .table-span-true{
        width: 120px;
        padding: 7px;
        border-radius: 7px;
        background-color: green;
        color: white;
    }
    .table-span-false{
        width: 120px;
        padding: 7px;
        border-radius: 7px;
        background-color: red;
        color: white;
    }
</style>

{% endblock navbar %}

{% block content %}
<div class="all-block">
    <div class="block1">
        <div class="title-adm">
            <h1>
                GERENCIAMENTO DE MODALIDADES
            </h1>
            <div class="title-buttons">
                {% if user.type != 2 %} <span onclick="openModal('{% if user.type == 1 %} {{user.event_user.id}} {% else %} {{ select_event }} {% endif %}')" {% else %} <span onclick="openTimeModal('{{ team.id }}')" {% endif %}><p>Novo</p></span>
                {% if user.type == 0 %}
                <form method="get" onsubmit="adicionarCamposOcultos(this)">
                    <select name="e" onchange="adicionarCamposOcultos(this.form); this.form.submit();">
                        <option value="">Evento</option>
                        {% for i in events %}
                            <option value="{{ i.id }}" {% if select_event|stringformat:"s" == i.id|stringformat:"s" %}selected{% endif %}>{{ i.name }}</option>
                        {% endfor %}
                    </select>
                </form>
                {% else %}
                <h3>
                    {{user.event_user.name}}
                </h3>
                {% endif %}
            </div>
        </div>
        <form method="get" onsubmit="adicionarCamposOcultos(this)" class="input-search-adm">
            <input name="q" type="search" placeholder="Procure por esportes, por sexo ou pelo ID">
        </form>
        {% if user.type != 2 %}
            {% if teams %}
            <form method="get" onsubmit="adicionarCamposOcultos(this)" class="menu_team">
                {% for i in teams %}
                <button type="submit" name="t" value="{{i.id}}" class="button_team">
                    <img src="{{i.photo.url}}" alt="" draggable="false">
                    <p>{{i.name}}</p>
                    {% if team.id == i.id %} <div class="item"></div> {% endif %}
                </button>
                {% endfor %}
            </form>
            {% else %}
            <section class="alert-page">
                <div class="alert-img"> <i class="fa-solid fa-circle-exclamation"></i> </div>
                <div class="alert-text">
                    <p>NÃO HÁ NENHUM EVENTO SELECIONADO.</p>
                </div>
            </section>
            {% endif %}
        {% endif %}
        {% if team %}
        {% if user.type != 2 %}
        <div class="subtitle-adm">
            <h2>{{team.name}}</h2>
            <div class="subtitle-buttons">
                <span class="subtitle-button-span" onclick="openTimeModal('{{ team.id }}')" style="background-color: var(--global-header-color);"><p>Novo esporte</p></span>
                <form method="POST" class="subtitle-button-file" style="background-color: #004ba0;">{% csrf_token %}<button name="team-data" value="{{team.id}}" type="submit"><i class="fa-solid fa-file"></i></button></form>
                <span class="subtitle-button-gear" onclick="openEditModal('{{ team.id }}','{{ team.name }}','{{ team.description }}','{{ team.photo.url }}','{{ team.status }}')"><i class="fa-solid fa-gear"></i></span>
            </div>
        </div>
        <p class="description-team">{{team.description}}</p>
        {% endif %}
        <section class="all-table" style="width: 100%; max-width: none; margin-top: 15px;">
            <table id="search-table" style="width: 100%;">
                <tr class="hidden error">
                    <th>ESPORTE</th>
                    <th>SEXO</th>
                    <th>AÇÕES</th>
                    <th>EDITAR</th>
                    <th>STATUS</th>
                    <th>DELETAR</th>
                </tr>

                {% for team_sport in team_sports %}
                <tr>
                    <td>{{ team_sport.sport.get_sport_display }}</td>
                    <td>{{ team_sport.get_sexo_display }}</td>
                    <td>
                        <a style="color: #0099ff;" href="{% url 'team_players_manage' team_sport.id %}"><i style="font-size: 21px;" class="fa-solid fa-eye"></i></a>
                    </td>
                    <td>
                        <a href="{% url 'team_edit' team_sport.id %}">
                            <img src="{% static 'images/icon-edit.svg' %}">
                        </a>
                    </td>
                    <td>{% if team_sport.status %} <span class="table-span-true">COMPLETO</span> {% else %} <span class="table-span-false">INCOMPLETO</span> {% endif %}</td>
                    <td>
                        <form method="POST">
                            {% csrf_token %}
                            <button data-confirm="Você realmente deseja excluir esta modalidade?"
                                name="team_sport_delete" value="{{team_sport.id}}"
                                style="background-color: transparent; border: none;">
                                <img src="{% static 'images/icon-trash.svg' %}" alt="">
                            </button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <style>
                    .hidden {
                        display: none;
                    }
                </style>
                <section class="alert-page">
                    <div class="alert-img"> <i class="fa-solid fa-circle-exclamation"></i> </div>
                    <div class="alert-text">
                        <p>NÃO HÁ NENHUMA MODALIDADE CADASTRADA NESSE TIME.</p>
                    </div>
                </section>
                {% endfor %}
            </table>
        </section>
        {% else %}
            {% if teams %}
                <section class="alert-page">
                    <div class="alert-img"> <i class="fa-solid fa-circle-exclamation"></i> </div>
                    <div class="alert-text">
                        <p>SELECIONE O TIME QUE DESEJA.</p>
                    </div>
                </section>
            {% endif %}
        {% endif %}
    </div>
</div>


<div id="timeModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeTimeModal()">&times;</span>
        <h2>Cadastrar esporte</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <label for="esportes">Esportes</label>
            <select id="times" name="sport_adm_id">
                <option selected disabled value="None">Selecione o esporte</option>
                {% for i in events_sport %}
                <option value="{{i.id}}">{{i.get_sport_display}}</option>
                {% endfor %}
            </select>
            <label for="sexos">Sexo</label>
            <select id="sexos" name="sexo_adm_id">
                <option selected disabled value="None">Selecione o sexo</option>
                <option value="0">Masculino</option>
                <option value="1">Feminino</option>
                <option value="2">Misto</option>
            </select>
            <input type="hidden" name="add-team-sport" id="addTimeId">
            <button class="button-modal" type="submit">Adicionar esporte</button>
        </form>
    </div>
</div>

<div id="eventModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Cadastrar time</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <label for="name">Nome</label>
            <input type="text" name="name" id="name" maxlength="100" required>

            <label for="description">Descrição</label>
            <textarea name="description" id="description" maxlength="200"></textarea>

            <label for="logo">Logo</label>
            <input type="file" name="photo" id="logo">

            <input type="hidden" name="add-team" id="eventId">

            <button class="button-modal" type="submit">Cadastrar time</button>
        </form>
    </div>
</div>

<div id="eventEditModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Editar time</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="edit-team" id="editTimeId" value="">

            <label for="name">Nome</label>
            <input type="text" name="edit-name" id="editTimeName" required>

            <label for="logo">Logo</label>
            <input type="file" name="edit-logo" id="editTimePhoto" onchange="previewFoto()">
            <p id="preview-name"></p>
            <img id="preview" src="" style="max-width: 200px; display: none; margin-top: 10px;">

            <label for="description">Descrição</label>
            <textarea name="edit-description" id="editTimeDescription" maxlength="200"></textarea>

            <div class="toggle-label"><span>Ativo</span><label class="toggle-switch"><input type="checkbox" name="edit-status" id="editTimeStatus"><span class="slider"></span></label></div>

            <button class="button-modal" type="submit">Salvar Alterações</button>
        </form>
    </div>
</div>

<script>
    function openModal(event) {
        console.log(event)
        document.getElementById("eventId").value = event;
        document.getElementById("eventModal").style.display = "block";
    }

    function closeModal() {
        document.getElementById("eventModal").style.display = "none";
    }

    function closeEditModal() {
        document.getElementById("eventEditModal").style.display = "none";
    }

    function openTimeModal(team) {
        document.getElementById("addTimeId").value = team;
        document.getElementById("timeModal").style.display = "block";
    }

    function closeTimeModal() {
        document.getElementById("timeModal").style.display = "none";
    }

    let originalPhotoUrl = '';

    function openEditModal(id, name, description, photoUrl, active) {
        originalPhotoUrl = photoUrl || '';
        
        // Resetar o input de foto
        const photoInput = document.getElementById('editTimePhoto');
        photoInput.value = '';
        
        // Preencher os campos do formulário
        document.getElementById("editTimeId").value = id;
        document.getElementById("editTimeName").value = name;
        document.getElementById("editTimeDescription").value = description;
        if (active == 'True'){
            document.getElementById("editTimeStatus").checked = true;
        }

        // Mostrar a imagem original
        const preview = document.getElementById('preview');
        const previewName = document.getElementById('preview-name');
        
        if (originalPhotoUrl) {
            preview.src = originalPhotoUrl;
            preview.style.display = 'block';
            previewName.textContent = "Fotografia atual:";
        } else {
            preview.style.display = 'none';
            previewName.textContent = "Nenhuma fotografia cadastrada";
        }

        document.getElementById("eventEditModal").style.display = "block";
    }

    function previewFoto() {
        const input = document.getElementById('editTimePhoto');
        const preview = document.getElementById('preview');
        const previewName = document.getElementById('preview-name');

        if (input.files && input.files[0]) {
            // Mostrar nova imagem selecionada
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
                previewName.textContent = "Nova fotografia:";
            };
            reader.readAsDataURL(input.files[0]);
        } else {
            if (originalPhotoUrl) {
                preview.src = originalPhotoUrl;
                preview.style.display = 'block';
                previewName.textContent = "Fotografia atual:";
            } else {
                preview.style.display = 'none';
                previewName.textContent = "Nenhuma fotografia cadastrada";
            }
        }
    }

    // Fecha os modais ao clicar fora
    window.onclick = function(event) {
        const modal1 = document.getElementById("eventModal");
        const modal2 = document.getElementById("timeModal");
        const modal3 = document.getElementById("eventEditModal");
        if (event.target == modal1) modal1.style.display = "none";
        if (event.target == modal2) modal2.style.display = "none";
        if (event.target == modal3) modal3.style.display = "none";
    }

    function adicionarCamposOcultos(form) {
        const currentParams = new URLSearchParams(window.location.search);

        // Remove campos ocultos antigos (evita duplicação ao voltar)
        const oldHiddenInputs = form.querySelectorAll('input[name][type=hidden]');
        oldHiddenInputs.forEach(el => el.remove());

        for (const [key, value] of currentParams.entries()) {
            // Não sobrescreve os inputs já existentes nesse form
            if (!form.querySelector(`[name="${key}"]`)) {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = key;
                hidden.value = value;
                form.appendChild(hidden);
            }
        }
    }
</script>

{% endblock content %}