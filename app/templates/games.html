{% extends 'base.html' %}
{% load static %}

{% block head %}
<title>ATUM ADMIN</title>
<link rel="stylesheet" href="{% static 'css/modal.css' %}">
<link rel="stylesheet" href="{% static 'css/match.css' %}">
{% endblock head %}

{% block content %}
<div class="all-block">
    <div class="block1">
        <div class="title-adm">
            <h1>GERENCIAMENTO DE PARTIDAS</h1>
            {% if perms.app.add_match or perms.app.add_phase or perms.app.add_groupphase %}
            <div class="title-buttons">
                {% if select_event %}
                <span onclick="openOptionsModal()"><p>Novo</p></span>
                {% endif %}
                {% if user.type == 0 %}
                <form method="get">
                    <select name="e" onchange="this.form.submit();">
                        <option value="">Evento</option>
                        {% for i in events %}
                            <option value="{{ i.id }}" {% if select_event|stringformat:"s" == i.id|stringformat:"s" %}selected{% endif %}>{{ i.name }}</option>
                        {% endfor %}
                    </select>
                </form>
                {% else %}
                <h3>{{ user.event_user.name }}</h3>
                {% endif %}
                {% if not select_event %}
                <h2>ADMIN</h2>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- ================== FILTRO ================== -->
        <div class="filter-container" {% if not select_event %} style="display: none;" {% endif %}>
          <button class="filter-toggle" onclick="toggleFilterMenu()">
            <i class="fa-solid fa-filter"></i> Filtros
          </button>

          <form class="filter-menu" id="filterMenu">
            <div class="filter-section">
              <button type="button" class="filter-category" onclick="toggleSubmenu('sport')">
                  <i class="fa-solid fa-futbol"></i> Esporte
              </button>
              <div class="filter-submenu" id="submenu-sport">
                  <select name="sport">
                      <option value="">Todos os Esportes</option>
                      {% for i in event_sports %}
                      <option value="{{i.sport}}">{{i.get_sport_display}}</option>
                      {% endfor %}
                  </select>
              </div>
            </div>

            <div class="filter-section">
              <button type="button" class="filter-category" onclick="toggleSubmenu('sexo')">
                  <i class="fa-solid fa-venus-mars"></i> Sexo
              </button>
              <div class="filter-submenu" id="submenu-sexo">
                  <select name="genre">
                    <option value="">Todos</option>
                    {% for i,j in sexo %}
                    <option value="{{i}}">{{j}}</option>
                    {% endfor %}
                  </select>
              </div>
            </div>

            <div class="filter-section">
              <button type="button" class="filter-category" onclick="toggleSubmenu('turma')">
                  <i class="fa-solid fa-users"></i> Times
              </button>
              <div class="filter-submenu" id="submenu-turma">
                  <select name="team">
                    <option value="">Todos</option>
                    {% for i in teams %}
                    <option value="{{i.id}}">{{i.name}}</option>
                    {% endfor %}
                  </select>
              </div>
            </div>

            <div class="filter-buttons">
                <button class="btn-filter">
                    <i class="fa-solid fa-check"></i>
                    <span>Aplicar</span>
                </button>
                <a href="" class="btn-clear">
                    <i class="fa-solid fa-rotate-right"></i>
                    <span>Limpar</span>
                </a>
            </div>
          </form>
        </div>


        <div class="games">
            {% for i in context %}
            <section class="game-card">
                <div class="game-header" {% if i.match.sexo == 1 %} style="background-color: #ee0063;" {% endif %}>
                    <h2>{{ i.match.get_sport_display }}</h2>
                    <span class="match-id">PARTIDA #{{ i.match.id }}</span>
                </div>

                <div class="game-content">
                    <div class="teams-section">
                        <div class="teams-vs">
                            <div class="team">
                                <span class="team-name">{{ i.times.0.team.name }}</span>
                                <span class="team-score" {% if i.match.sexo == 1 %} style="color: #ee005b;" {% endif %}>{{ i.points_a }}</span>
                            </div>
                            <span class="vs">VS</span>
                            <div class="team">
                                <span class="team-name">{{ i.times.1.team.name }}</span>
                                <span class="team-score" {% if i.match.sexo == 1 %} style="color: #ee005b;" {% endif %}>{{ i.points_b }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="match-details">
                        <div class="match-info">
                          <span class="info-tag">{{ i.match.get_sport_display }}</span>
                          <span class="info-tag">{{ i.match.get_sexo_display }}</span>
                          {% if i.match.group_phase.phase %}<span class="info-tag">{{ i.match.group_phase.phase.get_name_display }}</span>{% endif %}
                          {% if i.match.group_phase %}<span class="info-tag">{{ i.match.group_phase.name }}</span>{% endif %}
                        </div>
                        <div class="match-status">
                          {{ i.match.get_status_display }}
                        </div>
                        <div class="match-time">
                        {% if i.match.Winner_team %}
                            Vencedor: {{ i.match.Winner_team }}
                        {% else %}
                            {{ i.match.time_match|date:"d/m/Y - H:i" }}
                        {% endif %}
                        </div>
                        <div class="match-location">
                            {% if i.match.location %}
                            üìç {{ i.match.location }}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="game-actions">  
                    <a {% if i.match.status == 1 and user.type != 2 %} href="{% url 'scoreboard' i.match.event.id %}" {% endif %}>
                        <button {% if i.match.status == 1 %} class="action-btn action-btn-active" {% else %} class="action-btn action-btn-desactive"{% endif %}>
                            <i class="fa-solid fa-gamepad"></i>
                        </button>
                    </a>
                    <form method="post">{% csrf_token %}
                        <button class="action-btn" name="change_match" value="{{ i.match.id }}" type="submit" style="margin: 0; background-color: #282828;">
                            <i class="fa-solid fa-gear"></i>
                        </button>
                    </form>
                    <a href="{% url 'match_settings' i.match.sport i.match.id %}">  
                        <button class="action-btn" style="background-color: red;">
                            <i class="fa-solid fa-chart-line"></i>
                        </button>
                    </a>
                    <form method="post">{% csrf_token %}
                        <button class="action-btn" name="sumula" value="{{ i.match.id }}" style="margin: 0; background-color: #0289f7;">
                            <i class="fa-solid fa-file-text"></i>
                        </button>
                    </form>
                </div>
            </section>
            {% empty %}
            <section class="alert-page">
                <div class="alert-img">
                    <i class="fa-solid fa-circle-exclamation"></i> 
                </div>
                <div class="alert-text">
                    <p>N√ÉO H√Å NENHUMA PARTIDA PROGRAMADA.</p>
                </div>
            </section>
            {% endfor %}
        </div>
    </div>
</div>

{% if perms.app.add_match or perms.app.add_phase or perms.app.add_groupphase %}

<!-- ================= MODAL DE OP√á√ïES ================= -->
<div id="optionsModal" class="modal">
  <div class="modal-content" style="max-width: 400px; text-align:center;">
    <span class="close" onclick="closeOptionsModal()">&times;</span>
    <h2>O que deseja criar?</h2>
    <div class="buttons-options" style="margin-top: 2em; gap: 1em;">
        {% if perms.app.add_match %}
        <span class="button-op-1" style="background:#2196F3; display: flex; justify-content: space-evenly; align-items: center;" onclick="openModal('match')">
            <p style="color:white;">Partida</p>
            <i class="fa-solid fa-futbol" style="position: static;"></i>
        </span>
        {% endif %}
        {% if perms.app.add_phase %}
        <span class="button-op-2" style="background:#4CAF50; display: flex; justify-content: space-evenly; align-items: center;" onclick="openModal('phase')">
            <p style="color:white;">Fase</p>
            <i class="fa-solid fa-layer-group" style="position: static;"></i>
        </span>
        {% endif %}
        {% if perms.app.add_groupphase %}
        <span class="button-op-2" style="background:#FF9800; display: flex; justify-content: space-evenly; align-items: center;" onclick="openModal('group')">
            <p style="color:white;">Grupo</p>
            <i class="fa-solid fa-people-group" style="position: static;"></i>
        </span>
        {% endif %}
    </div>
  </div>
</div>

<!-- ================= MODAL PARTIDA ================= -->
{% if perms.app.add_match %}
<div id="modal-match" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('match')">&times;</span>
        <h2>Cadastrar partida</h2>
        <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <label for="sport">Esporte</label>
        <select id="sport" name="sport">
            <option selected disabled value="None">Selecione o esporte</option>
            {% for i in event_sports %}
            <option value="{{i.id}}">
            {{i.get_sport_display}}
            </option>
            {% endfor %}
        </select>

        <label for="group">Fase / Grupo</label>
        <select id="group" name="group">
            <option selected disabled value="">Selecione a fase/grupo</option>
        </select>

        <label for="sexo">Sexo</label>
        <select id="sexo" name="sexo" disabled>
            <option selected disabled value="None">Selecione o sexo</option>
        </select>

        <div id="team-selects" style="display: none;">
            <label for="time-a">Time A</label>
            <select id="time-a" name="time_a" required></select>

            <label for="time-b">Time B</label>
            <select id="time-b" name="time_b" required></select>
        </div>

        <label for="location">Local</label>
        <input type="text" id="location" name="location" placeholder="Informe o local" />

        <label for="date-game">Hor√°rio</label>
        <input class="input-data" type="datetime-local" name="datetime" id="date-game" />
        <p style="color: #6d6c6c; font-size: 15px;">*Informe a data e hor√°rio da partida ou coloque o hor√°rio por ordem de partida.</p>
        <button type="submit">Cadastrar</button>
        </form>
    </div>
</div>
{% endif %}

<!-- ================= MODAL FASE ================= -->
{% if perms.app.add_phase %}
<div id="modal-phase" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('phase')">&times;</span>
    <h2>Cadastrar Fase</h2>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="create_phase">
      <label>Evento / Esporte</label>
      <select name="event_sport" required>
        <option value="" disabled selected>Selecione</option>
        {% for e in event_sports %}
          <option value="{{ e.id }}">{{ e.get_sport_display }}</option>
        {% endfor %}
      </select>

      <label for="sexo_phase">Sexo</label>
      <select id="sexo_phase" name="sexo_phase" disabled>
          <option selected disabled value="None">Selecione o sexo</option>
      </select>

      <label>Nome da Fase</label>
      <select name="name" required>
        {% for value, name in phase_types %}
          <option value="{{ value }}">{{ name }}</option>
        {% endfor %}
      </select>

      <button type="submit">Cadastrar</button>
    </form>
  </div>
</div>
{% endif %}

<!-- ================= MODAL GRUPO ================= -->
{% if perms.app.add_groupphase %}
<div id="modal-group" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('group')">&times;</span>
    <h2>Cadastrar Grupo</h2>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="create_group">
      <label>Fase</label>
      <select name="phase" required>
        <option value="" disabled selected>Selecione a fase</option>
        {% for p in phases %}
          <option value="{{ p.id }}">{{ p.get_name_display }} - {{ p.event.get_sport_display }} - {{ p.get_sexo_display }}</option>
        {% endfor %}
      </select>

      <label>Nome do Grupo</label>
      <input type="text" name="group_name" placeholder="Ex: Grupo A">

      <button type="submit">Cadastrar</button>
    </form>
  </div>
</div>
{% endif %}
{% endif %}

<script>
  const sportSelect = document.getElementById("sport");
  const sexoSelect = document.getElementById("sexo");
  const timeASelect = document.getElementById("time-a");
  const timeBSelect = document.getElementById("time-b");
  const teamDiv = document.getElementById("team-selects");

  // ---------- 1Ô∏è‚É£ Carregar sexos para o modal de FASE ----------
  const eventSportPhaseSelect = document.querySelector('#modal-phase select[name="event_sport"]');
  const sexoPhaseSelect = document.getElementById("sexo_phase");

  async function carregarSexosPhase() {
    const sport = eventSportPhaseSelect.value;
    if (sport && sport !== "None") {
      const response = await fetch(`/get_sexos/?sport=${sport}`);
      const data = await response.json();

      // Limpa e preenche select de sexo_phase
      sexoPhaseSelect.innerHTML = '<option selected disabled value="None">Selecione o sexo</option>';
      data.sexos.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.value;
        opt.textContent = s.label;
        sexoPhaseSelect.appendChild(opt);
      });

      sexoPhaseSelect.disabled = false;
    } else {
      sexoPhaseSelect.innerHTML = '<option selected disabled value="None">Selecione o sexo</option>';
      sexoPhaseSelect.disabled = true;
    }
  }

  if (eventSportPhaseSelect) {
    eventSportPhaseSelect.addEventListener("change", carregarSexosPhase);
  }

  // ---------- 1Ô∏è‚É£ Carregar sexos dispon√≠veis ao selecionar esporte ----------
  async function carregarSexos() {
    const sport = sportSelect.value;
    if (sport && sport !== "None") {
      const response = await fetch(`/get_sexos/?sport=${sport}`);
      const data = await response.json();

      // Limpa e preenche select de sexo
      sexoSelect.innerHTML = '<option selected disabled value="None">Selecione o sexo</option>';
      data.sexos.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.value;
        opt.textContent = s.label;
        sexoSelect.appendChild(opt);
      });

      sexoSelect.disabled = false;
      // Limpa e oculta selects de times
      teamDiv.style.display = "none";
      timeASelect.innerHTML = '';
      timeBSelect.innerHTML = '';
    } else {
      sexoSelect.innerHTML = '<option selected disabled value="None">Selecione o sexo</option>';
      sexoSelect.disabled = true;
      teamDiv.style.display = "none";
    }
  }

  // ---------- 2Ô∏è‚É£ Carregar times dispon√≠veis ao selecionar esporte + sexo ----------
  async function carregarTimes() {
    const sport = sportSelect.value;
    const sexo = sexoSelect.value;

    if (sport && sexo && sport !== "None" && sexo !== "None") {
      const response = await fetch(`/get_teams/?sport=${sport}&sexo=${sexo}`);
      const data = await response.json();
      console.log(data)

      // Limpa selects
      timeASelect.innerHTML = '<option selected disabled value="None">Selecione o time</option>';
      timeBSelect.innerHTML = '<option selected disabled value="None">Selecione o time</option>';

      // Preenche selects com os times retornados
      data.teams.forEach(team => {
        const optA = document.createElement("option");
        const optB = document.createElement("option");
        optA.value = team.id;
        optB.value = team.id;
        optA.textContent = team.name;
        optB.textContent = team.name;
        timeASelect.appendChild(optA);
        timeBSelect.appendChild(optB);
      });

      teamDiv.style.display = "block";
    } else {
      teamDiv.style.display = "none";
    }
  }



  // ---------- 3Ô∏è‚É£ Evitar selecionar mesmo time em A e B ----------
  function atualizarOpcoesTimes() {
    const selectedA = timeASelect.value;
    const selectedB = timeBSelect.value;

    // Reabilita todas as op√ß√µes antes de desabilitar
    for (let opt of timeASelect.options) opt.disabled = false;
    for (let opt of timeBSelect.options) opt.disabled = false;

    if (selectedA && selectedA !== "None") {
      for (let opt of timeBSelect.options) {
        if (opt.value === selectedA) opt.disabled = true;
      }
    }
    if (selectedB && selectedB !== "None") {
      for (let opt of timeASelect.options) {
        if (opt.value === selectedB) opt.disabled = true;
      }
    }
  }
    const groupSelect = document.getElementById("group");

    async function carregarGrupos() {
        const sport = sportSelect.value;
        if (sport && sport !== "None") {
            const response = await fetch(`/get_groups/?sport=${sport}`);
            const data = await response.json();

            // Limpa o select
            groupSelect.innerHTML = '<option selected disabled value="">Selecione a fase/grupo</option>';

            // Preenche com os grupos retornados
            data.groups.forEach(g => {
                const opt = document.createElement("option");
                opt.value = g.id;
                opt.textContent = `${g.phase_name} - ${g.sexo} | ${g.name}`;
                groupSelect.appendChild(opt);
            });
        } else {
            groupSelect.innerHTML = '<option selected disabled value="">Selecione a fase/grupo</option>';
        }
    }
  // ---------- 4Ô∏è‚É£ Event listeners ----------
  sportSelect.addEventListener("change", () => {
    carregarSexos();
    // Limpa e esconde times
    teamDiv.style.display = "none";
    timeASelect.innerHTML = '';
    timeBSelect.innerHTML = '';
    carregarGrupos();
  });

  sexoSelect.addEventListener("change", carregarTimes);
  timeASelect.addEventListener("change", atualizarOpcoesTimes);
  timeBSelect.addEventListener("change", atualizarOpcoesTimes);
    function openOptionsModal() { document.getElementById("optionsModal").style.display = "block"; }
    function closeOptionsModal() { document.getElementById("optionsModal").style.display = "none"; }
    function openModal(type) { closeOptionsModal(); document.getElementById("modal-" + type).style.display = "block"; }
    function closeModal(type) { document.getElementById("modal-" + type).style.display = "none"; }
  function toggleFilterMenu() {
  const menu = document.getElementById("filterMenu");
  menu.style.display = menu.style.display === "flex" ? "none" : "flex";
}

function toggleSubmenu(name) {
  const submenu = document.getElementById(`submenu-${name}`);
  const allSubmenus = document.querySelectorAll(".filter-submenu");
  allSubmenus.forEach(sm => {
    if (sm !== submenu) sm.style.display = "none";
  });
  submenu.style.display = submenu.style.display === "block" ? "none" : "block";
}

</script>
{% endblock content %}