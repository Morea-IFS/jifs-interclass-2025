{% extends 'base.html' %}
{% load static %}

{% block head %}
<title>ATUM ADMIN</title>
<link rel="stylesheet" href="{% static 'css/modal.css' %}">
{% endblock head %}

{% block navbar %}
<style>

</style>
{% endblock navbar %}

{% block content %}

<div class="all-block">
    <div class="block1">
        <div class="title-adm">
            <h1>
                GERENCIAMENTO DE PARTIDAS
            </h1>
            {% if perms.app.add_match %}
            <div class="title-buttons">
                {% if user.event_user or select_event %}
                <span onclick="openModal()"><p>Novo</p></span>
                {% else %}
                <h3>EVENTO -></h3>
                {% endif %}
                {% if user.type == 0 %}
                <form method="get">
                    <select name="e" onchange="this.form.submit();">
                        <option value="">Evento</option>
                        {% for i in events %}
                            <option value="{{ i.id }}" {% if select_event|stringformat:"s" == i.id|stringformat:"s" %}selected{% endif %}>{{ i.name }}</option>
                        {% endfor %}
                    </select>
                </form>
                {% else %}
                <h3>
                    {{user.event_user.name}}
                </h3>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="games">
            {% for i in context %}
            <section class="game-section">
                <div class="game-block1">
                    <div class="game-title">
                        <h1 {% if i.match.sexo == 1 %}  style="color: #ee005b;" {% endif %}>{{ i.times.0.team.name }} <span style="color: black;">X</span> {{ i.times.1.team.name }}</h1>
                    </div>
                    <div {% if i.match.sexo == 1 %} style="background-color: #ee005b;" {% endif %} class="game-score">{{ i.points_a }} x {{ i.points_b }}</div>
                </div>
                <div class="game-block2">
                    <p>PARTIDA #{{i.match.id}}<br>{{i.match.get_sexo_display}}<br>{{ i.match.get_sport_display }}</p>
                    <h2>{{i.match.get_status_display}}</h2>
                    <h3>{% if i.match.Winner_team %} Vencedor:  {{ i.match.Winner_team }} {% else %} {{i.match.time_match|date:"d/m/Y - H:i" }} {% endif %}</h3>
                </div>
                <div class="games-config">  
                    <a class="games-config-link" {% if i.match.status == 1 and user.type != 2 %} href="{% url 'scoreboard' i.match.event.id %}" {% endif %}>
                        <div {% if i.match.status == 1 %} class="games-config-item games-config-item-active" {% else %} class="games-config-item games-config-item-desactive"{% endif %}>
                            <img class="games-config-item-img" src="{% static 'images/icon-timer.png' %}"
                                alt="Timer Icon" />
                        </div>
                    </a>
                    <a class="games-config-link">
                        <form method="post" class="games-config-item">{% csrf_token %}
                            <button name="change_match" value="{{i.match.id}}" type="submit" style="margin: 0; background-color: transparent;"><img class="games-config-item-img" src="{% static 'images/icon-config.png' %}"
                                alt="Gear Icon" /></button>
                        </form>
                    </a>
                    <a class="games-config-link" href="{% url 'match_settings' i.match.sport i.match.id %}">
                        <div class="games-config-item games-config-item-player">
                            <img class="games-config-item-img" src="{% static 'images/icon-player.png' %}"
                                alt="Player Icon" />
                        </div>
                    </a>
                </div>
            </section>
            {% empty %}
            <section class="alert-page">
                <div class="alert-img">
                <i class="fa-solid fa-circle-exclamation"></i> 
                </div>
                <div class="alert-text">
                    <p>NÃO HÁ NENHUMA PARTIDA PROGRAMADA.</p>
                </div>
            </section>
            {% endfor %}

        </div>
    </div>
</div>
{% if perms.app.add_match %}

<div id="eventModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Cadastrar partida</h2>
        <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <label for="sport">Esporte</label>
        <select id="sport" name="sport">
            <option selected disabled value="None">Selecione o esporte</option>
            {% for i in event_sports %}
            <option value="{{i.id}}">
            {{i.get_sport_display}}
            {% if i.masc %}(masc){% endif %}
            {% if i.fem %}(fem){% endif %}
            {% if i.mist %}(mist){% endif %}
            </option>
            {% endfor %}
        </select>

        <label for="sexo">Sexo</label>
        <select id="sexo" name="sexo" disabled>
            <option selected disabled value="None">Selecione o sexo</option>
        </select>

        <div id="team-selects" style="display: none;">
            <label for="time-a">Time A</label>
            <select id="time-a" name="time_a" required></select>

            <label for="time-b">Time B</label>
            <select id="time-b" name="time_b" required></select>
        </div>

        <label for="date-game">Horário</label>
        <input class="input-data" type="datetime-local" name="datetime" id="date-game" />
        <p style="color: #6d6c6c; font-size: 15px;">*Informe a data e horário da partida ou coloque o horário por ordem de partida.</p>
        <button type="submit">Cadastrar</button>
        </form>
    </div>
</div>

<script>
    function openModal() {
        document.getElementById("eventModal").style.display = "block";
    }

    function closeModal() {
        document.getElementById("eventModal").style.display = "none";
    }
</script>
<script>
  const sportSelect = document.getElementById("sport");
  const sexoSelect = document.getElementById("sexo");
  const timeASelect = document.getElementById("time-a");
  const timeBSelect = document.getElementById("time-b");
  const teamDiv = document.getElementById("team-selects");

  // ---------- 1️⃣ Carregar sexos disponíveis ao selecionar esporte ----------
  async function carregarSexos() {
    const sport = sportSelect.value;
    if (sport && sport !== "None") {
      const response = await fetch(`/get_sexos/?sport=${sport}`);
      const data = await response.json();

      // Limpa e preenche select de sexo
      sexoSelect.innerHTML = '<option selected disabled value="None">Selecione o sexo</option>';
      data.sexos.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.value;
        opt.textContent = s.label;
        sexoSelect.appendChild(opt);
      });

      sexoSelect.disabled = false;
      // Limpa e oculta selects de times
      teamDiv.style.display = "none";
      timeASelect.innerHTML = '';
      timeBSelect.innerHTML = '';
    } else {
      sexoSelect.innerHTML = '<option selected disabled value="None">Selecione o sexo</option>';
      sexoSelect.disabled = true;
      teamDiv.style.display = "none";
    }
  }

  // ---------- 2️⃣ Carregar times disponíveis ao selecionar esporte + sexo ----------
  async function carregarTimes() {
    const sport = sportSelect.value;
    const sexo = sexoSelect.value;

    if (sport && sexo && sport !== "None" && sexo !== "None") {
      const response = await fetch(`/get_teams/?sport=${sport}&sexo=${sexo}`);
      const data = await response.json();

      // Limpa selects
      timeASelect.innerHTML = '<option selected disabled value="None">Selecione o time</option>';
      timeBSelect.innerHTML = '<option selected disabled value="None">Selecione o time</option>';

      // Preenche selects com os times retornados
      data.teams.forEach(team => {
        const optA = document.createElement("option");
        const optB = document.createElement("option");
        optA.value = team.id;
        optB.value = team.id;
        optA.textContent = team.name;
        optB.textContent = team.name;
        timeASelect.appendChild(optA);
        timeBSelect.appendChild(optB);
      });

      teamDiv.style.display = "block";
    } else {
      teamDiv.style.display = "none";
    }
  }

  // ---------- 3️⃣ Evitar selecionar mesmo time em A e B ----------
  function atualizarOpcoesTimes() {
    const selectedA = timeASelect.value;
    const selectedB = timeBSelect.value;

    // Reabilita todas as opções antes de desabilitar
    for (let opt of timeASelect.options) opt.disabled = false;
    for (let opt of timeBSelect.options) opt.disabled = false;

    if (selectedA && selectedA !== "None") {
      for (let opt of timeBSelect.options) {
        if (opt.value === selectedA) opt.disabled = true;
      }
    }
    if (selectedB && selectedB !== "None") {
      for (let opt of timeASelect.options) {
        if (opt.value === selectedB) opt.disabled = true;
      }
    }
  }

  // ---------- 4️⃣ Event listeners ----------
  sportSelect.addEventListener("change", () => {
    carregarSexos();
    // Limpa e esconde times
    teamDiv.style.display = "none";
    timeASelect.innerHTML = '';
    timeBSelect.innerHTML = '';
  });

  sexoSelect.addEventListener("change", carregarTimes);
  timeASelect.addEventListener("change", atualizarOpcoesTimes);
  timeBSelect.addEventListener("change", atualizarOpcoesTimes);
</script>


{% endif %}
{% endblock content %}